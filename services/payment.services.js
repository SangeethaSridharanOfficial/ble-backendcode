const { check, validationResult } = require("express-validator/check");
const sgMail = require('@sendgrid/mail')
const Payment = require("../model/Payment");
const stripe = require('stripe')('sk_test_51IZNXDEpsLVtl1KC3UHkBvlRNc1bhFK7PHAs8H7b24VVCqaO3CIUbHM93flnbuE5rg2uVf6wRWTYwppDTLOq20A100FgCBhYyo');
const Joi = require('joi');

async function savePaymentToMongo(email, amount, paymentId) {
    let payment = new Payment({
        email: email,
        amount: amount,
        payment_id: paymentId
    });
    await payment.save();
    sendPaymentEmail(email, amount)
}

function sendPaymentEmail(email, amount) {
    amount = amount.substring(0, amount.length - 2) + "." + amount.substring(amount.length - 2);
    //sgMail.setApiKey(process.env.SENDGRID_API_KEY)
    sgMail.setApiKey("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");
    //sgMail.setApiKey("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")
    const msg = {
        to: email, // Change to your recipient
        from: 'info@synnovate.ca', // Change to your verified sender
        subject: 'Bill amount $' + amount,
        text: '. Your bill amount is ' + amount,
        html: 'This is an autogenerated email for your invoice. <br/><strong>You bill amount is ' + amount + '</strong><br/>Thank you for using Gas Dispenser App.',
    }
    sgMail
        .send(msg)
        .then(() => {
            console.log('Email sent')
        })
        .catch((error) => {
            console.error(error)
        })
}

module.exports = {
    payment: async(req, res) => {
        try {
            console.log('data from client : amount : ' + req.body.amount + ' ' );
            stripe.paymentIntents.create({
                    amount: req.body.amount,
                    /*billing_details: {
                        name: 'Jenny Rosen',
                        email: 'jenny@example.com',
                    },*/
                    //customer: req.body.email,
                    currency: 'cad',
                    payment_method_types: ['card'],
                }).then((charge) => {
                    // asynchronously called
    
                    // await payment.save();
                    savePaymentToMongo(req.body.email, req.body.amount, charge["id"]);
                    //console.log('data from client : ' + req.body.amount + ' ' + req.body.currency + " email : " + req.body.email);
                    res.send({
                        "message":"Your Payment is successfully Accepted.Please check your email for a receipt.",
                        "success":"true"
                    })
                    //res.send(charge);
                    //console.log('Response from function : ' + charge["id"]);
                })
                .catch(err => {
                    console.log(err);
                });
        } catch (e) {
            res.send({ message: "Error in Fetching " });
        }
    }
}